--FUNCIONES DE NORTHWIND
--1. Función Escalar – Total gastado por un cliente

DROP FUNCTION IF EXISTS dbo.fn_TotalCompradoCliente;
GO

-- Devuelve el monto total comprado por un cliente de Northwind
CREATE FUNCTION dbo.fn_TotalCompradoCliente (@CustomerID nchar(5))
RETURNS MONEY
AS
BEGIN
    DECLARE @Total MONEY;

    SELECT @Total = SUM(od.UnitPrice * od.Quantity * (1 - od.Discount))
    FROM Orders o
    JOIN [Order Details] od ON o.OrderID = od.OrderID
    WHERE o.CustomerID = @CustomerID;

    RETURN ISNULL(@Total, 0);
END;
GO

--2. Función Escalar – Obtener nombre completo del empleado

DROP FUNCTION IF EXISTS dbo.fn_NombreCompletoEmpleado;
GO

CREATE FUNCTION dbo.fn_NombreCompletoEmpleado(@EmployeeID INT)
RETURNS VARCHAR(100)
AS
BEGIN
    DECLARE @Nombre VARCHAR(100);

    SELECT @Nombre = FirstName + ' ' + LastName
    FROM Employees
    WHERE EmployeeID = @EmployeeID;

    RETURN ISNULL(@Nombre, 'No encontrado');
END;
GO

--3. Función Tabla – Productos bajo cierto precio

DROP FUNCTION IF EXISTS dbo.fn_ProductosBajoPrecio;
GO

CREATE FUNCTION dbo.fn_ProductosBajoPrecio(@Precio MONEY)
RETURNS TABLE
AS
RETURN (
    SELECT ProductID, ProductName, UnitPrice
    FROM Products
    WHERE UnitPrice <= @Precio
);
GO


--FUNCIONES DE PUBS
--4. Función Escalar – Obtener nombre completo de un autor

DROP FUNCTION IF EXISTS dbo.fn_NombreCompletoAutor;
GO

CREATE FUNCTION dbo.fn_NombreCompletoAutor (@Au_ID VARCHAR(20))
RETURNS VARCHAR(200)
AS
BEGIN
    DECLARE @Nombre VARCHAR(200);

    SELECT @Nombre = au_fname + ' ' + au_lname
    FROM authors
    WHERE au_id = @Au_ID;

    RETURN ISNULL(@Nombre, 'Autor no encontrado');
END;
GO

SELECT dbo.fn_NombreCompletoAutor('172-32-1176');
GO

--5. Función Tabla – Libros y precios de un autor

DROP FUNCTION IF EXISTS dbo.fn_LibrosPorAutor;
GO

CREATE FUNCTION dbo.fn_LibrosPorAutor (@Au_ID VARCHAR(20))
RETURNS TABLE
AS
RETURN (
    SELECT t.title, t.price, t.type
    FROM titles t
    JOIN titleauthor ta ON t.title_id = ta.title_id
    WHERE ta.au_id = @Au_ID
);
GO

SELECT * FROM dbo.fn_LibrosPorAutor('238-95-7766');
GO

--6. Función Tabla – Ventas por tienda
DROP FUNCTION IF EXISTS dbo.fn_VentasPorTienda;
GO

CREATE FUNCTION dbo.fn_VentasPorTienda (@StoreID CHAR(4))
RETURNS TABLE
AS
RETURN (
    SELECT s.stor_name, t.title, SUM(sales.qty) AS CantidadVendida
    FROM stores s
    JOIN sales ON s.stor_id = sales.stor_id
    JOIN titles t ON t.title_id = sales.title_id
    WHERE s.stor_id = @StoreID
    GROUP BY s.stor_name, t.title
);
GO

SELECT * FROM dbo.fn_VentasPorTienda('8042');
GO

--7. Devuelve cuántos libros tiene una editorial (publisher) en la base de datos PUBS.
IF OBJECT_ID('dbo.fn_CountBooksByPublisher', 'FN') IS NOT NULL
    DROP FUNCTION dbo.fn_CountBooksByPublisher;
GO

CREATE FUNCTION dbo.fn_CountBooksByPublisher (@PubID CHAR(4))
RETURNS INT
AS
BEGIN
    DECLARE @Total INT;

    SELECT @Total = COUNT(*)
    FROM pubs.dbo.titles
    WHERE pub_id = @PubID;

    RETURN @Total;
END;
GO

SELECT dbo.fn_CountBooksByPublisher('1389');
GO


--FUNCIONES DE ADVENTUREWORKS
--8. Devolver el nombre completo de un empleado (FirstName + LastName)
CREATE OR ALTER FUNCTION dbo.NombreCompletoEmpleado
(
    @BusinessEntityID INT
)
RETURNS VARCHAR(200)
AS
BEGIN
    DECLARE @Nombre VARCHAR(200);

    SELECT @Nombre = p.FirstName + ' ' + p.LastName
    FROM HumanResources.Employee e
    INNER JOIN Person.Person p 
        ON e.BusinessEntityID = p.BusinessEntityID
    WHERE e.BusinessEntityID = @BusinessEntityID;

    RETURN ISNULL(@Nombre, 'No existe');
END;
GO

SELECT dbo.NombreCompletoEmpleado(1) AS NombreCompleto;
GO

--9. Calcular el precio promedio histórico de un producto
CREATE OR ALTER FUNCTION dbo.CostoPromedioProducto
(
    @ProductID INT
)
RETURNS DECIMAL(10,2)
AS
BEGIN
    DECLARE @Promedio DECIMAL(10,2);

    SELECT @Promedio = AVG(StandardCost)
    FROM Production.ProductCostHistory
    WHERE ProductID = @ProductID;

    RETURN ISNULL(@Promedio, 0);
END;
GO

SELECT dbo.CostoPromedioProducto(707) AS CostoPromedio;
GO

--10. Obtener todos los productos con sus modelos y número de ilustraciones
CREATE OR ALTER FUNCTION dbo.InfoProductosModelos()
RETURNS TABLE
AS
RETURN
(
    SELECT 
        p.ProductID,
        p.Name AS Producto,
        pm.Name AS Modelo,
        COUNT(pmi.IllustrationID) AS CantidadIlustraciones
    FROM Production.Product p
    LEFT JOIN Production.ProductModel pm 
        ON p.ProductModelID = pm.ProductModelID
    LEFT JOIN Production.ProductModelIllustration pmi
        ON p.ProductModelID = pmi.ProductModelID
    GROUP BY 
        p.ProductID, p.Name, pm.Name
);
GO

-- PRUEBA
SELECT TOP 20 * FROM dbo.InfoProductosModelos();
GO
